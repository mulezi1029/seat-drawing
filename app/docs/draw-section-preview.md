# Draw-Section 预览功能说明

## 概述

Draw-Section 工具用于绘制区域多边形，提供实时预览和智能对齐辅助功能，帮助用户精确定位顶点。

## 核心预览元素

| 元素 | 样式 | 说明 |
|------|------|------|
| 已绘制顶点 | 蓝色圆点（第一个为绿色，半径 4px） | 标记已添加的多边形顶点 |
| 起始点 | 绿色圆点（半径 6px） | 标识多边形的第一个点，可点击闭合 |
| 已完成线段 | 蓝色实线（#3b82f6） | 连接已添加的点 |
| 预览线 | 蓝色虚线（#3b82f6，dasharray: 4,4） | 从最后一点跟随鼠标到当前位置 |

## 对齐辅助线系统

### 辅助线显示

| 辅助线 | 默认状态 | 对齐状态 | 触发条件 |
|--------|----------|----------|----------|
| 水平辅助线 | 灰色实线（#94a3b8，1px） | **绿色实线**（#22c55e，2px） | 鼠标 Y 坐标与某已有点相同（±5px 阈值） |
| 垂直辅助线 | 灰色实线（#94a3b8，1px） | **绿色实线**（#22c55e，2px） | 鼠标 X 坐标与某已有点相同（±5px 阈值） |
| 对齐标记 | - | 绿色小圆点（#22c55e，半径 4px） | 在对齐位置显示标记 |

### 辅助线特点

- **贯穿画布**：辅助线覆盖整个 world 坐标范围（±25000）
- **非缩放描边**：使用 `vector-effect="non-scaling-stroke"`，线宽保持恒定
- **实时更新**：鼠标移动时 60fps 实时渲染
- **透明度**：辅助线 60% 透明度，避免遮挡内容

## 交互方式

### 添加顶点
1. 点击画布添加第一个点（显示为绿色）
2. 移动鼠标，看到预览线跟随
3. 再次点击添加下一个点
4. 重复直到完成多边形

### 闭合多边形
- **点击起点**：当鼠标靠近第一个点（<15px）时，点击可闭合
- **双击**：双击完成多边形绘制
- **按 Enter**：至少 3 个点后按 Enter 完成

### 撤销操作
- **右键点击**：删除最后一个点
- **Backspace/Delete**：删除最后一个点
- **Ctrl+Z**：撤销最后一个点
- **ESC**：取消整个绘制

## 技术实现

### 文件位置
- `src/render/OverlayRenderer.ts` - 渲染对齐辅助线和预览
- `src/tools/DrawSectionTool.ts` - 工具逻辑
- `src/components/canvas/Canvas.tsx` - 鼠标事件处理

### 核心方法

```typescript
// OverlayRenderer.ts
renderDrawingPreview(points: Point[], currentPos: Point | null): void
renderAlignmentGuides(points: Point[], currentPos: Point): void
```

### 对齐检测逻辑

```typescript
const snapThreshold = 5; // 5px 吸附阈值

// 检查水平对齐
for (const point of points) {
  if (Math.abs(point.y - currentPos.y) <= snapThreshold) {
    // 水平对齐，水平线变绿
  }
}

// 检查垂直对齐
for (const point of points) {
  if (Math.abs(point.x - currentPos.x) <= snapThreshold) {
    // 垂直对齐，垂直线变绿
  }
}
```

## 样式常量

| 颜色 | 色值 | 用途 |
|------|------|------|
| 蓝色 | #3b82f6 | 默认线段、普通顶点 |
| 绿色 | #10b981 | 起始点 |
| 亮绿 | #22c55e | 对齐状态、对齐标记 |
| 灰色 | #94a3b8 | 默认辅助线 |
| 白色 | #ffffff | 顶点描边 |

## 视觉效果

### 正常状态
```
    ●──────●
           │
           │ ← 灰色水平辅助线
           │
    ───────┼───────  ← 灰色垂直辅助线
           │
           ○ 鼠标位置
```

### 对齐状态
```
    ●══════●
           ║
           ║ ← 绿色水平辅助线（与上方点对齐）
           ║
    ───────╫───────
           ● 鼠标位置（显示对齐标记）
```

## 注意事项

1. 辅助线仅在绘制模式下显示（mode === 'draw-section'）
2. 至少需要 3 个点才能形成有效多边形
3. 共线的点无法创建有效多边形（会提示警告）
4. 辅助线使用 SVG line 元素，性能开销极小
