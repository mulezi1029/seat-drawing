# 导入背景图问题排查指南

## 问题描述

导入数据后，区域和座位数据正常显示，但背景底图没有展示。

---

## 排查步骤

### 步骤 1：检查导出的数据

1. 打开导出的 JSON 文件
2. 查找 `backgroundImage` 字段
3. 确认该字段的值

**预期结果**：
```json
{
  "backgroundImage": "data:image/svg+xml;base64,..." 
}
```

或

```json
{
  "backgroundImage": "http://example.com/image.svg"
}
```

或

```json
{
  "backgroundImage": null
}
```

**如果是 `null`**：
- 说明导出时没有背景图
- 需要重新上传背景图并导出

### 步骤 2：查看浏览器控制台

1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 导入数据
4. 查看控制台输出

**查找关键信息**：

```
[导入] 开始导入文件: xxx.json
[导入] 恢复背景图
[导入] 背景图 URL 类型: Data URL / HTTP URL
[导入] 背景图 URL 前 100 字符: ...
[导入] ✅ 背景图验证成功
[BackgroundLayer] svgUrl 变化: ...
[BackgroundLayer] 渲染背景图
[BackgroundLayer] ✅ 图片加载成功
```

**常见错误**：

❌ `[导入] 无背景图数据`
- 原因：JSON 文件中 backgroundImage 为 null
- 解决：重新上传背景图并导出

❌ `[导入] ❌ 背景图验证失败`
- 原因：背景图 URL 无效或格式错误
- 解决：检查 URL 格式

❌ `[BackgroundLayer] ❌ 图片加载失败`
- 原因：图片无法加载
- 解决：检查图片格式和内容

### 步骤 3：检查背景图格式

**支持的格式**：
- ✅ Data URL (base64 编码)
- ✅ HTTP/HTTPS URL
- ❌ 本地文件路径 (file://)

**Data URL 格式**：
```
data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPi4uLjwvc3ZnPg==
```

**HTTP URL 格式**：
```
https://example.com/venue-background.svg
```

### 步骤 4：手动测试背景图

在浏览器控制台执行：

```javascript
// 获取导出的数据
const data = /* 粘贴你的 JSON 数据 */;

// 测试背景图是否可以加载
const img = new Image();
img.onload = () => console.log('✅ 图片可以加载');
img.onerror = (e) => console.error('❌ 图片加载失败:', e);
img.src = data.backgroundImage;
```

### 步骤 5：检查 React 状态

在浏览器控制台执行：

```javascript
// 检查当前 svgUrl 状态
// 注意：这需要 React DevTools
```

或者在代码中添加：

```typescript
useEffect(() => {
  console.log('当前 svgUrl:', svgUrl);
}, [svgUrl]);
```

---

## 常见问题与解决方案

### 问题 1：导出时没有背景图

**症状**：
- JSON 中 `backgroundImage: null`
- 控制台显示 "无背景图数据"

**原因**：
- 导出时确实没有上传背景图

**解决方案**：
1. 上传背景图（点击上传按钮）
2. 重新导出数据
3. 导入新的 JSON 文件

### 问题 2：Data URL 被截断

**症状**：
- JSON 文件很小
- backgroundImage 字段不完整

**原因**：
- 导出时数据被截断
- 文件保存不完整

**解决方案**：
1. 重新导出数据
2. 确保文件完整保存
3. 检查文件大小是否合理

### 问题 3：HTTP URL 无法访问

**症状**：
- 控制台显示网络错误
- 图片加载失败

**原因**：
- URL 失效
- 网络连接问题
- CORS 跨域问题

**解决方案**：
1. 检查网络连接
2. 在浏览器中直接访问 URL
3. 使用 Data URL 代替 HTTP URL

### 问题 4：SVG 格式错误

**症状**：
- Data URL 存在但图片不显示
- 控制台无明显错误

**原因**：
- SVG 内容格式错误
- base64 编码错误

**解决方案**：
1. 解码 base64 查看 SVG 内容
2. 验证 SVG 格式
3. 重新上传背景图

### 问题 5：浏览器兼容性

**症状**：
- 某些浏览器可以显示，某些不行

**原因**：
- 浏览器对 SVG 的支持不同
- Data URL 大小限制

**解决方案**：
1. 使用最新版本的 Chrome/Firefox/Edge
2. 压缩 SVG 文件
3. 使用 HTTP URL 代替 Data URL

---

## 调试工具

### 1. 解码 Data URL

```javascript
function decodeDataURL(dataURL) {
  const base64 = dataURL.split(',')[1];
  const decoded = atob(base64);
  console.log(decoded);
  return decoded;
}

// 使用
const svgContent = decodeDataURL(data.backgroundImage);
```

### 2. 验证 SVG 内容

```javascript
function validateSVG(svgContent) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(svgContent, 'image/svg+xml');
  const errors = doc.getElementsByTagName('parsererror');
  
  if (errors.length > 0) {
    console.error('❌ SVG 格式错误:', errors[0].textContent);
    return false;
  }
  
  console.log('✅ SVG 格式正确');
  return true;
}
```

### 3. 检查文件大小

```javascript
function checkFileSize(dataURL) {
  const sizeInBytes = dataURL.length;
  const sizeInKB = (sizeInBytes / 1024).toFixed(2);
  const sizeInMB = (sizeInBytes / 1024 / 1024).toFixed(2);
  
  console.log(`文件大小: ${sizeInBytes} bytes (${sizeInKB} KB / ${sizeInMB} MB)`);
  
  if (sizeInMB > 10) {
    console.warn('⚠️ 文件过大，可能导致性能问题');
  }
}
```

---

## 临时解决方案

### 方案 1：重新上传背景图

如果导入后背景图不显示：

1. 保留导入的区域和座位数据
2. 手动上传背景图
3. 重新导出（包含背景图）

### 方案 2：手动设置背景图

在浏览器控制台执行：

```javascript
// 假设你有背景图的 URL
const backgroundURL = 'data:image/svg+xml;base64,...';

// 手动设置（需要访问 React 状态）
// 这需要修改代码添加全局方法
```

### 方案 3：使用外部图片

1. 将背景图上传到图床
2. 获取 HTTP URL
3. 手动修改 JSON 文件中的 backgroundImage
4. 重新导入

---

## 预防措施

### 1. 导出前检查

导出前确认：
- ✅ 背景图已上传
- ✅ 背景图正常显示
- ✅ 所有数据完整

### 2. 导出后验证

导出后检查：
- ✅ 文件大小合理
- ✅ JSON 格式正确
- ✅ backgroundImage 字段存在

### 3. 导入前测试

导入前：
- ✅ 在测试环境先导入
- ✅ 验证数据完整性
- ✅ 确认背景图显示

---

## 联系支持

如果以上方法都无法解决问题，请提供：

1. 导出的 JSON 文件（可以脱敏）
2. 浏览器控制台完整日志
3. 浏览器版本和操作系统
4. 背景图文件（如果可以）

---

*最后更新: 2026-02-26*
