# 数据导入导出功能说明

## 功能概述

数据导入导出功能允许用户保存和恢复场馆座位数据，实现数据持久化和跨设备共享。

**版本**: v1.6.0  
**更新日期**: 2026-02-26

---

## 功能特性

### 1. 数据导出

将当前场馆的所有数据导出为 JSON 文件，包括：
- 区域信息（位置、形状、颜色）
- 座位数据（位置、行号、座位号、类型、角度）
- 校准参数（座位尺寸、间距）
- 背景图 URL
- 元数据（创建时间、座位总数等）

### 2. 数据导入

从 JSON 文件导入场馆数据，恢复完整的场馆配置。

---

## 使用方法

### 导出数据

#### 方式 1：使用顶部工具栏按钮

1. 点击顶部工具栏的 **下载图标** (Download)
2. 浏览器自动下载 JSON 文件
3. 文件名格式：`{场馆名称}-{时间戳}.json`

#### 方式 2：使用快捷键（计划中）

- `Ctrl/Cmd + E`：导出数据

#### 导出的文件内容

```json
{
  "version": "1.0.0",
  "timestamp": "2026-02-26T10:30:00.000Z",
  "venueName": "Untitled Venue",
  "backgroundImage": "data:image/svg+xml;base64,...",
  "sections": [
    {
      "id": "section-1234567890",
      "name": "A区",
      "points": [
        { "x": 100, "y": 100 },
        { "x": 500, "y": 100 },
        { "x": 500, "y": 400 },
        { "x": 100, "y": 400 }
      ],
      "color": "#3b82f6",
      "opacity": 0.3,
      "seats": [
        {
          "id": "seat-1234567890-0",
          "x": 50,
          "y": 50,
          "row": "A",
          "number": 1,
          "type": "normal",
          "angle": 0
        }
      ],
      "calibrationData": {
        "canvasScale": 3.0,
        "anchorScale": 3.0,
        "seatVisual": {
          "size": 35,
          "gapX": 15,
          "gapY": 25
        },
        "isCalibrated": true
      }
    }
  ],
  "metadata": {
    "totalSections": 1,
    "totalSeats": 100,
    "createdAt": "2026-02-26T10:00:00.000Z",
    "modifiedAt": "2026-02-26T10:30:00.000Z"
  }
}
```

### 导入数据

#### 方式 1：使用顶部工具栏按钮

1. 点击顶部工具栏的 **上传图标** (Upload)
2. 选择之前导出的 JSON 文件
3. 查看导入确认对话框：
   ```
   确认导入场馆数据？
   
   场馆名称: 体育馆
   区域数量: 5
   座位总数: 1500
   
   当前数据将被替换！
   ```
4. 点击"确定"完成导入

#### 方式 2：使用快捷键（计划中）

- `Ctrl/Cmd + I`：导入数据

#### 导入流程

```
1. 选择文件
   ↓
2. 验证格式
   ↓
3. 解析数据
   ↓
4. 显示确认对话框
   ↓
5. 用户确认
   ↓
6. 替换当前数据
   ↓
7. 恢复背景图（如果有）
   ↓
8. 完成导入
```

---

## 数据格式说明

### ExportData 接口

```typescript
interface ExportData {
  /** 版本号 */
  version: string;
  
  /** 导出时间 (ISO 8601) */
  timestamp: string;
  
  /** 场馆名称 */
  venueName: string;
  
  /** 背景图 URL (Data URL 或 HTTP URL) */
  backgroundImage: string | null;
  
  /** 区域数据数组 */
  sections: Section[];
  
  /** 元数据 */
  metadata: {
    totalSections: number;
    totalSeats: number;
    createdAt: string;
    modifiedAt: string;
  };
}
```

### Section 接口

```typescript
interface Section {
  /** 唯一标识符 */
  id: string;
  
  /** 区域名称 */
  name: string;
  
  /** 多边形顶点（世界坐标） */
  points: Point[];
  
  /** 颜色 (hex) */
  color: string;
  
  /** 不透明度 (0-1) */
  opacity: number;
  
  /** 座位数组 */
  seats: Seat[];
  
  /** 校准数据 */
  calibrationData?: CalibrationData;
}
```

### Seat 接口

```typescript
interface Seat {
  /** 唯一标识符 */
  id: string;
  
  /** X 坐标（局部坐标，相对于区域原点） */
  x: number;
  
  /** Y 坐标（局部坐标，相对于区域原点） */
  y: number;
  
  /** 行号 (如 "A", "B", "C") */
  row: string;
  
  /** 座位号 (如 1, 2, 3) */
  number: number;
  
  /** 座位类型 */
  type: 'normal' | 'vip' | 'accessible' | 'empty';
  
  /** 旋转角度 (0-360°) */
  angle: number;
}
```

---

## 注意事项

### 导出注意事项

1. **背景图处理**：
   - 如果背景图是 Data URL（base64），会完整保存
   - 如果背景图是 HTTP URL，只保存 URL（导入时需要网络访问）

2. **文件大小**：
   - 包含 base64 背景图的文件可能较大（几 MB）
   - 建议定期清理不需要的区域和座位

3. **数据完整性**：
   - 导出前确保所有数据已保存
   - 导出的数据包含完整的校准信息

### 导入注意事项

1. **数据覆盖警告**：
   - 导入会**完全替换**当前数据
   - 导入前建议先导出当前数据作为备份

2. **格式验证**：
   - 只能导入由本系统导出的 JSON 文件
   - 手动修改 JSON 文件可能导致导入失败

3. **版本兼容性**：
   - 当前版本：1.0.0
   - 未来版本会保持向后兼容

4. **背景图恢复**：
   - Data URL 背景图可以完整恢复
   - HTTP URL 背景图需要网络连接

---

## 使用场景

### 场景 1：数据备份

```
1. 完成场馆设计
2. 点击导出按钮
3. 保存 JSON 文件到本地或云盘
4. 定期更新备份
```

### 场景 2：跨设备工作

```
设备 A:
1. 设计场馆
2. 导出数据

设备 B:
1. 打开应用
2. 导入数据
3. 继续编辑
4. 导出更新后的数据

设备 A:
1. 导入最新数据
2. 继续工作
```

### 场景 3：模板复用

```
1. 创建标准场馆模板
2. 导出为 JSON 文件
3. 新项目导入模板
4. 基于模板修改
```

### 场景 4：数据迁移

```
旧系统:
1. 导出所有场馆数据

新系统:
1. 逐个导入场馆数据
2. 验证数据完整性
3. 继续使用
```

---

## 工具函数 API

### exportVenueData

导出场馆数据为对象。

```typescript
function exportVenueData(
  sections: Section[],
  backgroundImage: string | null,
  venueName?: string
): ExportData
```

### exportAndDownload

导出并下载 JSON 文件。

```typescript
function exportAndDownload(
  sections: Section[],
  backgroundImage: string | null,
  venueName?: string
): void
```

### importVenueData

从文件导入场馆数据。

```typescript
async function importVenueData(file: File): Promise<{
  sections: Section[];
  backgroundImage: string | null;
  venueName: string;
  metadata: ExportData['metadata'];
}>
```

### generateSummary

生成可读的数据摘要。

```typescript
function generateSummary(data: ExportData): string
```

**示例输出**：
```
场馆名称: 体育馆
导出时间: 2026/2/26 10:30:00
版本: 1.0.0

区域数量: 5
座位总数: 1500

区域详情:
  1. A区 - 300 个座位 (已校准)
  2. B区 - 300 个座位 (已校准)
  3. C区 - 400 个座位 (已校准)
  4. VIP区 - 200 个座位 (已校准)
  5. 残疾人区 - 300 个座位 (已校准)
```

---

## 常见问题

### Q: 导出的文件可以手动编辑吗？

**A**: 可以，但需要注意：
- 保持 JSON 格式正确
- 不要修改数据结构
- 坐标值需要合理
- 建议使用 JSON 编辑器

### Q: 导入后背景图不显示？

**A**: 可能的原因：
1. 背景图是 HTTP URL，网络连接失败
2. Data URL 格式错误
3. 浏览器不支持该图片格式

解决方法：
- 重新上传背景图
- 检查网络连接
- 使用 SVG 格式背景图

### Q: 导入失败怎么办？

**A**: 检查以下几点：
1. 文件是否为有效的 JSON 格式
2. 文件是否由本系统导出
3. 文件是否被损坏
4. 浏览器控制台是否有错误信息

### Q: 可以导入其他系统的数据吗？

**A**: 目前不支持。未来可能会提供：
- 数据格式转换工具
- 其他系统的导入适配器

### Q: 导出的数据安全吗?

**A**: 注意事项：
- JSON 文件为明文，任何人都可以查看
- 不要在文件中包含敏感信息
- 建议加密存储重要数据

---

## 技术实现

### 文件结构

```
app/src/utils/
  └── dataExport.ts          # 导入导出工具函数

app/src/components/panels/
  └── PanelTop.tsx           # 顶部工具栏（包含导入导出按钮）

app/src/App.tsx              # 主应用（集成导入导出功能）
```

### 核心流程

#### 导出流程

```typescript
1. 收集数据
   - sections: 区域数组
   - backgroundImage: 背景图 URL
   - venueName: 场馆名称

2. 构建导出对象
   - 添加版本号
   - 添加时间戳
   - 计算元数据

3. 序列化为 JSON
   - JSON.stringify()
   - 格式化缩进

4. 创建 Blob
   - type: application/json

5. 触发下载
   - createObjectURL()
   - <a> 标签下载
```

#### 导入流程

```typescript
1. 读取文件
   - FileReader.readAsText()

2. 解析 JSON
   - JSON.parse()

3. 验证格式
   - validateImportData()

4. 用户确认
   - window.confirm()

5. 更新状态
   - setSections()
   - setVenueName()
   - uploadSvg()
```

---

## 未来计划

### 短期计划

- [ ] 添加导入导出快捷键
- [ ] 支持拖拽导入文件
- [ ] 导入前预览数据
- [ ] 导出时选择包含内容

### 中期计划

- [ ] 支持导出为 CSV 格式
- [ ] 支持导出为 Excel 格式
- [ ] 批量导入导出
- [ ] 数据版本管理

### 长期计划

- [ ] 云端同步
- [ ] 协作编辑
- [ ] 历史版本回溯
- [ ] 数据加密

---

## 更新日志

### v1.6.0 (2026-02-26)

- ✨ 新增数据导出功能
- ✨ 新增数据导入功能
- ✨ 新增数据格式验证
- ✨ 新增导入确认对话框
- ✨ 新增数据摘要生成
- 📝 完善功能文档

---

*文档结束*
