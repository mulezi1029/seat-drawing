# 座位绘制系统画布架构设计

## 当前实现概览

基于 seats.io 的画布结构，已构建可扩展的模块化画布系统，当前实现进度约 70%。

**已实现功能**:
- 场馆背景图展示与导航 (Space+拖拽平移、Ctrl+滚轮缩放、鼠标中键平移、360°摇杆控制)
- 区域绘制与编辑 (矩形/多边形，支持吸附、对齐、旋转)
- 选择工具 (点选、框选、多选、拖拽移动、旋转)
- 属性面板框架与工具栏UI
- 吸附辅助系统 (网格/顶点/角度/对齐)

**待实现功能**:
- 座位绘制 (单点/行/线/多行)
- 属性面板数据绑定
- 撤销/重做系统
- 座位选择工具

---

## 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│  #designerApp (主应用容器)                                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ panel-top (顶部工具栏)                                        ││
│  │ [Logo] [Help] [Undo] [Redo] [Duplicate] [Delete]             ││
│  └─────────────────────────────────────────────────────────────┘│
│  ┌──────────┬──────────────────────────────────┬──────────────┐ │
│  │panel-left│         Canvas Area              │ panel-right  │ │
│  │(工具选择)│  ┌────────────────────────────┐  │ (属性面板)    │ │
│  │          │  │  SVG Renderer              │  │              │ │
│  │ [V]选择  │  │  - Background Image        │  │ [Grid]       │ │
│  │ [X]座位  │  │  - Grid Layer              │  │ [Section]    │ │
│  │ [C]刷选  │  │  - Sections (Polygons)     │  │ [Category]   │ │
│  │          │  │  - Drawing Preview         │  │ [Transform]  │ │
│  │ [S]矩形  │  │  - Guide Lines             │  │ [Label]      │ │
│  │ [P]多边形│  │  - Hover Highlight         │  │ [Misc]       │ │
│  │ [E]圆桌  │  │  - Bounding Box            │  │              │ │
│  │          │  │  - Selection Box           │  │              │ │
│  │ [1-4]座位│  │  - Cursor Guide            │  │              │ │ │
│  │ [Space]手│  │                            │  │              │ │
│  └──────────┴──────────────────────────────────┴──────────────┘ │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ Floating Controls (悬浮控件)                                 ││
│  │ ┌──────────┐ ┌──────────┐ ┌────────────────┐               ││
│  │ │Navigation│ │Joystick  │ │ StatusBar      │               ││
│  │ │HUD (↑↓←→)│ │(360°摇杆)│ │ (底部状态栏)    │               ││
│  │ └──────────┘ └──────────┘ └────────────────┘               ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

---

## 组件结构详解

### 1. 顶层布局 (App.tsx)

```tsx
<div className="designer-app min-h-screen flex flex-col bg-background">
  <PanelTop />           {/* 顶部工具栏: Logo, 操作按钮 */}
  <div className="workspace flex-1 flex overflow-hidden">
    <PanelLeft          {/* 左侧工具选择 */}
      activeTool={activeTool}
      onToolSelect={setActiveTool}
    />
    <CanvasContainer    {/* 画布容器: 视口导航、事件处理 */}
      ref={canvasRef}
      activeTool={activeTool}
      sections={sections}
      selectedIds={selectedIds}
      onSectionsChange={setSections}
      onSelectionChange={setSelectedIds}
      {...handlers}
    />
    <PanelRight         {/* 右侧属性面板 */}
      showGrid={showGrid}
      gridSize={gridSize}
      onGridChange={...}
    />
  </div>
  <FloatingControls     {/* 悬浮控件: 导航、缩放、摇杆 */}
    viewer={viewer}
    onZoomIn={zoomIn}
    onZoomOut={zoomOut}
    onReset={resetView}
  />
</div>
```

**核心状态管理** (React useState):
```typescript
// App.tsx 全局状态
const [activeTool, setActiveTool] = useState('select');      // 当前工具
const [previousTool, setPreviousTool] = useState('select');  // 临时切换前工具
const [sections, setSections] = useState<Section[]>([]);     // 区域数据
const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set()); // 选中元素
const [showGrid, setShowGrid] = useState(true);              // 网格显示
const [gridSize, setGridSize] = useState(50);                // 网格大小
```

---

### 2. 核心组件设计

#### CanvasContainer (画布容器) - Canvas.tsx

**职责**: 处理视口导航（平移/缩放）和工具交互事件

**状态**:
```typescript
// 绘制状态
const [isDrawing, setIsDrawing] = useState(false);
const [drawingPoints, setDrawingPoints] = useState<Point[]>([]);
const [drawingMode, setDrawingMode] = useState<'rectangle' | 'polygon' | null>(null);

// 选择状态
const [isDraggingElement, setIsDraggingElement] = useState(false);
const [isRotating, setIsRotating] = useState(false);
const [selectionBox, setSelectionBox] = useState<SelectionBoxType | null>(null);
const [hoveredElement, setHoveredElement] = useState<string | null>(null);

// 拖拽旋转状态
const [dragStart, setDragStart] = useState<Point | null>(null);
const [selectedSectionsAtDragStart, setSelectedSectionsAtDragStart] = useState<Section[]>([]);
const [rotationAngle, setRotationAngle] = useState(0);
```

**交互实现**:
| 交互 | 实现方式 | 说明 |
|------|---------|------|
| Space + 拖拽 | 直接操作 DOM 滚动 | `containerRef.current.scrollLeft/Top` |
| 鼠标中键 | onMouseDown 检测 `e.button === 1` | 光标切换 grabbing |
| Ctrl + 滚轮 | 原生事件监听器 `passive: false` | 阻止默认行为，精细缩放 |
| 普通滚轮 | 垂直滚轮 → 垂直移动，Shift+滚轮 → 水平移动 | 直接操作 DOM |
| 光标管理 | 使用 `cursorStyleRef` 直接设置 style | 避免 React 重渲染 |

**坐标转换** (coordinate.ts):
```typescript
// 世界画布配置
export const CANVAS_CONFIG = {
  WORLD_SIZE: 50000,
  WORLD_CENTER: 25000,
  WORLD_MIN: -25000,
  WORLD_MAX: 25000,
};

// Screen → World
export function screenToWorld(
  screenX: number,
  screenY: number,
  container: HTMLElement,
  scale: number
): Point {
  const rect = container.getBoundingClientRect();
  const scrollLeft = container.scrollLeft;
  const scrollTop = container.scrollTop;

  const viewportX = (screenX - rect.left + scrollLeft) / scale;
  const viewportY = (screenY - rect.top + scrollTop) / scale;

  return {
    x: viewportX - CANVAS_CONFIG.WORLD_CENTER,
    y: viewportY - CANVAS_CONFIG.WORLD_CENTER,
  };
}

// World → Screen
export function worldToScreen(
  worldX: number,
  worldY: number,
  container: HTMLElement,
  scale: number
): Point {
  const scrollLeft = container.scrollLeft;
  const scrollTop = container.scrollTop;

  const viewportX = worldX + CANVAS_CONFIG.WORLD_CENTER;
  const viewportY = worldY + CANVAS_CONFIG.WORLD_CENTER;

  return {
    x: viewportX * scale - scrollLeft,
    y: viewportY * scale - scrollTop,
  };
}
```

---

#### SVGRenderer (SVG 渲染器) - SVGRenderer.tsx

**职责**: 渲染所有 SVG 图形元素，采用分层架构

**实现方式**: 使用 `width/height` 固定尺寸 (50000×50000)，通过 `transform` 进行视口变换

```tsx
<svg
  width={CANVAS_CONFIG.WORLD_SIZE}
  height={CANVAS_CONFIG.WORLD_SIZE}
  className="absolute top-0 left-0"
>
  <g
    className="world-layer"
    transform={`translate(${CANVAS_CONFIG.WORLD_CENTER}, ${CANVAS_CONFIG.WORLD_CENTER}) scale(${scale}) translate(${-CANVAS_CONFIG.WORLD_CENTER}, ${-CANVAS_CONFIG.WORLD_CENTER})`}
  >
    {/* Layer 0: 背景图 */}
    <BackgroundLayer svgUrl={svgUrl} />

    {/* Layer 1: 网格辅助线 */}
    {showGrid && <GridLayer gridSize={gridSize} scale={scale} />}

    {/* Layer 2: 区域层 */}
    <SectionsLayer
      sections={sections}
      selectedIds={selectedIds}
      onSectionClick={handleSectionClick}
    />

    {/* Layer 3: 座位层 (占位) */}
    <SeatsLayer />

    {/* Layer 4-7: 交互覆盖层 */}
    <DrawingPreviewLayer {...} />      {/* 绘制预览 */}
    <GuideLinesLayer {...} />          {/* 吸附辅助线 */}
    <HoverHighlightLayer {...} />      {/* 悬停高亮 */}
    <BoundingBoxLayer {...} />         {/* 边界框+旋转手柄 */}
    <SelectionBoxLayer {...} />        {/* 框选框 */}
    <CursorGuideLayer {...} />         {/* 光标十字线 */}
  </g>
</svg>
```

**渲染分层 (Z-Index)**:
```
Layer 0: 背景图 (BackgroundImage)
Layer 1: 网格辅助线 (Grid) - 可配置显示/隐藏
Layer 2: 区域填充 (Section Fill)
Layer 3: 区域边框 (Section Stroke)
Layer 4: 座位 (Seats) - 待实现
Layer 5: 绘制预览 (Drawing Preview)
Layer 6: 吸附辅助线 (Snap Guides)
Layer 7: 尺寸标注 (Dimension Label)
Layer 8: 悬停高亮 (Hover Highlight)
Layer 9: 拖拽辅助线 (Drag Guide)
Layer 10: 边界框+旋转手柄 (Bounding Box)
Layer 11: 框选矩形 (Selection Box)
Layer 12: 光标十字线 (Cursor Guide)
```

---

### 3. 坐标系统设计

**核心原则**: 数据层存储真实世界坐标，变换仅用于预览

**坐标流程**:
```
Screen (屏幕坐标 - 鼠标事件)
    ↓ screenToWorld()
World (世界坐标 - 数据存储)

世界画布: 50000×50000 像素
中心点: (25000, 25000)
数据范围: (-25000, -25000) ~ (25000, 25000)
```

**元素变换策略**:
```typescript
// 移动过程中 - 使用 transform 预览
<path
  d="M9883.298...,10037.742..."  // 原始世界坐标不变
  transform={`translate(${CANVAS_CONFIG.WORLD_CENTER},${CANVAS_CONFIG.WORLD_CENTER}) scale(${scale}) translate(${-CANVAS_CONFIG.WORLD_CENTER},${-CANVAS_CONFIG.WORLD_CENTER}) translate(${deltaX}, ${deltaY})`}
/>

// 移动完成后 - 更新数据，重置 transform
<path
  d="M9983.298...,9987.742..."    // 更新后的世界坐标
  transform={`translate(${CANVAS_CONFIG.WORLD_CENTER},${CANVAS_CONFIG.WORLD_CENTER}) scale(${scale}) translate(${-CANVAS_CONFIG.WORLD_CENTER},${-CANVAS_CONFIG.WORLD_CENTER})`}
/>
```

---

### 4. 工具系统设计

**当前实现**: 简单字符串标识 + 条件渲染

**工具列表**:
| 工具 | ID | 快捷键 | 功能 | 实现状态 |
|------|----|--------|------|---------|
| 选择 | select | V | 框选、点选对象 | 完成 |
| 节点选择 | node | A | 编辑多边形节点 | 占位 |
| 座位选择 | seat-select | X | 选择座位 | 占位 |
| 刷选 | brush | C | 刷选工具 | 占位 |
| 矩形区域 | section-rect | S | 拖拽绘制矩形区域 | 完成 |
| 多边形区域 | section-poly | P | 逐点绘制多边形 | 完成 |
| 单座位 | seat-single | 1 | 点击放置单个座位 | 占位 |
| 行座位 | seat-row | 2 | 拖拽绘制一行座位 | 占位 |
| 线座位 | seat-line | 3 | 点击多点绘制沿线座位 | 占位 |
| 多行座位 | seat-multi | 4 | 拖拽绘制多行座位 | 占位 |
| 平移 | hand | Space | 平移画布 | 完成 |

**工具切换逻辑** (App.tsx):
```typescript
// Space 键临时切换到手型工具
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.code === 'Space' && !e.repeat && !isSpacePressed) {
      e.preventDefault();
      setIsSpacePressed(true);
      setPreviousTool(activeTool);
      setActiveTool('hand');
    }
  };

  const handleKeyUp = (e: KeyboardEvent) => {
    if (e.code === 'Space') {
      e.preventDefault();
      setIsSpacePressed(false);
      setActiveTool(previousTool);  // 恢复之前的工具
    }
  };

  // 其他快捷键...
}, [activeTool, previousTool, isSpacePressed]);
```

---

### 5. 吸附系统设计

**多层级吸附策略**:
```typescript
export function findSnapPoint(
  point: Point,
  options: SnapOptions,
  existingSections: Section[]
): SnapResult | null {
  // 1. 网格吸附 (优先级最低)
  const gridSnap = snapToGrid(point, gridSize);

  // 2. 顶点吸附
  const vertexSnap = findNearestVertex(point, allPoints, threshold);

  // 3. 角度吸附 (相对于吸附中心)
  const angleSnap = calculateAngleSnap(point, snapCenter, angleStep);

  // 4. 对齐吸附 (与其他元素对齐)
  const alignment = findAlignment(point, existingSections, threshold);

  // 选择最优吸附点...
}
```

**吸附类型**:
- **网格吸附**: 对齐到网格线交点
- **顶点吸附**: 吸附到现有多边形的顶点
- **角度吸附**: 以第一个点为圆心，保持固定角度间隔 (15°)
- **对齐吸附**: 水平/垂直对齐到其他元素

**缩放自适应容差**:
```typescript
const SNAP_THRESHOLD = 10; // 屏幕像素
const screenThreshold = SNAP_THRESHOLD / scale; // 世界坐标容差
```

---

### 6. 选择系统设计

**选择逻辑** (selection.ts):
```typescript
// 点选 - 射线法检测点是否在多边形内
export function isPointInPolygon(point: Point, polygon: Point[]): boolean {
  let inside = false;
  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i].x, yi = polygon[i].y;
    const xj = polygon[j].x, yj = polygon[j].y;
    const intersect = ((yi > point.y) !== (yj > point.y))
        && (point.x < (xj - xi) * (point.y - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}

// 框选 - 边界框相交/包含检测
export function findElementsInBox(
  sections: Section[],
  box: BoundingBox,
  mode: 'intersect' | 'contain'
): string[] {
  return sections.filter(section => {
    const elementBox = getBoundingBox(section.points);
    return mode === 'intersect'
      ? doBoundingBoxesIntersect(elementBox, box)
      : isBoundingBoxContained(elementBox, box);
  }).map(s => s.id);
}
```

**交互方式**:
- **单击**: 选择单个对象
- **Ctrl + 单击**: 多选切换
- **拖拽**: 框选多个对象
- **Ctrl + 拖拽**: 添加到当前选择
- **Ctrl + A**: 全选
- **Esc**: 取消选择
- **Delete**: 删除选中

---

### 7. 状态管理设计

**当前架构**: React 原生 useState (简化设计，无全局状态管理库)

**状态分布**:
```typescript
// App.tsx - 全局状态
interface AppState {
  // 工具层
  activeTool: string;
  previousTool: string;
  isSpacePressed: boolean;

  // 数据层
  sections: Section[];

  // 选择层
  selectedIds: Set<string>;

  // 视图层
  showGrid: boolean;
  gridSize: number;
}

// Canvas.tsx - 本地交互状态
interface CanvasState {
  // 绘制状态
  isDrawing: boolean;
  drawingPoints: Point[];
  drawingMode: 'rectangle' | 'polygon' | null;

  // 选择状态
  isDraggingElement: boolean;
  isRotating: boolean;
  selectionBox: SelectionBox | null;
  hoveredElement: string | null;

  // 拖拽旋转状态
  dragStart: Point | null;
  selectedSectionsAtDragStart: Section[];
  rotationAngle: number;
}

// useSimpleViewer.ts - 视图状态
interface ViewerState {
  svgUrl: string | null;
  scale: number;
  offsetX: number;
  offsetY: number;
}
```

**状态流**:
```
用户交互 → Canvas 事件处理 → 回调到 App → 更新 sections → 重新渲染 SVGRenderer
```

---

### 8. 交互设计

#### 区域绘制 (矩形)
1. 选择矩形工具 (S)
2. 拖拽绘制矩形
3. Shift 约束正方形
4. Ctrl 从中心绘制
5. 松开完成

#### 区域绘制 (多边形)
1. 选择多边形工具 (P)
2. 点击添加顶点
3. 移动鼠标预览下一边
4. 点击起点或双击闭合
5. Enter 完成，Esc 取消

#### 元素移动
1. 选择要移动的元素
2. 在边界框内拖拽
3. 吸附辅助线自动出现
4. 松开完成移动

#### 元素旋转
1. 选中元素
2. 点击旋转手柄 (顶部小圆点)
3. 拖拽旋转
4. 15° 增量吸附
5. 松开完成旋转

#### 快捷键
| 快捷键 | 功能 |
|--------|------|
| V | 选择工具 |
| S | 矩形区域工具 |
| P | 多边形工具 |
| 1-4 | 座位工具 (待实现) |
| Space + 拖拽 | 平移画布 |
| Ctrl + 滚轮 | 缩放 |
| Ctrl + Z | 撤销 (占位) |
| Ctrl + Shift + Z | 重做 (占位) |
| Ctrl + C/D | 复制选中 |
| Delete | 删除选中 |
| Esc | 取消/退出 |
| Ctrl + A | 全选 |

---

### 9. 属性面板设计

**已实现面板**:
```
┌─────────────┐
│ Grid        │
│ ├─ Show Grid│
│ └─ Grid Size│
│    [10/50/100]
└─────────────┘
```

**待实现面板** (UI 已就绪):
```
┌─────────────┐
│ Section     │
│ ├─ Edit     │
│ ├─ Name     │
│ └─ Seats: 0 │
├─────────────┤
│ Category    │
│ └─ Color    │
├─────────────┤
│ Transform   │
│ ├─ Scale    │
│ └─ Smooth   │
├─────────────┤
│ Label       │
│ ├─ Text     │
│ ├─ Visible  │
│ ├─ FontSize │
│ ├─ Rotation │
│ └─ Pos X/Y  │
├─────────────┤
│ View Image  │
│ [Upload]    │
├─────────────┤
│ Misc        │
│ └─ Entrance │
└─────────────┘
```

---

## 文件结构设计

```
app/src/
├── components/
│   ├── canvas/
│   │   ├── Canvas.tsx           # 画布容器 (950行, 事件处理+视口管理)
│   │   ├── SVGRenderer.tsx      # SVG 渲染器 (1113行, 分层渲染)
│   │   └── index.ts             # 模块导出
│   ├── panels/
│   │   ├── PanelTop.tsx         # 顶部工具栏
│   │   ├── PanelLeft.tsx        # 左侧工具选择 (14个工具)
│   │   ├── PanelRight.tsx       # 右侧属性面板
│   │   ├── FloatingControls.tsx # 悬浮控件 (导航+摇杆+缩放)
│   │   └── index.ts
│   └── ui/                      # shadcn/ui 组件
│       ├── button.tsx
│       └── tooltip.tsx
├── hooks/
│   ├── useSimpleViewer.ts       # 视图控制Hook (背景图+缩放+平移)
│   └── index.ts
├── types/
│   └── index.ts                 # 全局类型定义
├── utils/
│   ├── coordinate.ts            # 坐标转换+吸附计算 (300行)
│   └── selection.ts             # 选择逻辑+几何计算 (235行)
├── lib/
│   └── utils.ts                 # 工具函数 (cn)
├── App.tsx                      # 主应用组件 (全局状态)
├── App.css                      # 应用样式
├── index.css                    # 全局样式
└── main.tsx                     # 入口文件
```

---

## 实现阶段

### Phase 1: 基础架构 (已完成)
- ✅ Canvas 组件视口管理
- ✅ 坐标转换系统
- ✅ SVGRenderer 分层渲染
- ✅ 光标样式管理

### Phase 2: 绘制工具 (已完成)
- ✅ 矩形区域绘制 (Shift约束, Ctrl中心绘制)
- ✅ 多边形区域绘制 (点击闭合, 双击闭合)
- ✅ 吸附系统 (网格/顶点/角度/对齐)
- ✅ 绘制预览

### Phase 3: 选择工具 (已完成)
- ✅ 点选 (射线法精确检测)
- ✅ 框选 (边界框相交检测)
- ✅ 多选 (Ctrl+单击)
- ✅ 元素拖拽移动
- ✅ 元素旋转 (15°增量吸附)
- ✅ 复制/删除

### Phase 4: UI 面板 (80% 完成)
- ✅ 左侧工具栏 (14个工具, 7个已实现)
- ✅ 右侧属性面板框架
- ✅ 网格设置面板
- ✅ 悬浮控件 (导航+摇杆+缩放)
- ⬜ Section 属性编辑
- ⬜ Category 设置
- ⬜ 撤销/重做按钮

### Phase 5: 座位系统 (待实现)
- ⬜ 单座位工具
- ⬜ 行座位工具
- ⬜ 线座位工具
- ⬜ 多行座位工具
- ⬜ 座位选择工具

### Phase 6: 高级功能 (待实现)
- ⬜ 撤销/重做系统
- ⬜ 属性面板数据绑定
- ⬜ 座位编号自动生成
- ⬜ 导入/导出

---

## 关键设计决策

1. **状态管理**: 使用 React useState 而非全局状态管理库
   - 理由: 当前复杂度下足够使用，避免过度工程化

2. **坐标系统**: 中心原点坐标系，便于定位
   - 数据范围: (-25000, -25000) ~ (25000, 25000)
   - 与 seats.io 保持一致

3. **SVG 缩放**: 使用 `width/height` + `transform` 而非 `viewBox`
   - 与 seats.io 实现一致
   - 便于独立控制各图层

4. **性能优化**: 滚轮/拖拽使用 ref 直接操作 DOM
   - 避免 React 重渲染
   - 流畅的 60fps 体验

5. **旋转实现**: 保存原始 section 数据，避免累积误差
   - 每次旋转基于原始坐标计算
   - 数据即真理，无累积误差

6. **吸附容差**: 屏幕像素固定，缩放自适应
   - `SNAP_THRESHOLD = 10` 屏幕像素
   - 任意缩放级别下体验一致

---

## 与原始设计的差异

| 项目 | 原始设计 | 当前实现 | 原因 |
|------|---------|---------|------|
| 状态管理 | Zustand 全局 Store | React useState | 简化设计，当前够用 |
| 工具系统 | ToolManager 类 | 字符串标识+条件渲染 | 简化实现 |
| 坐标系统 | Screen→Viewport→World | 直接 Screen↔World | 减少中间层 |
| 撤销重做 | 命令模式 | 尚未实现 | 待后续添加 |
| 座位系统 | 完整实现 | 占位 | 开发中 |

---

## 技术亮点

1. **性能优化**: 滚轮/拖拽使用 ref 直接操作 DOM，避免 React 重渲染
2. **坐标系统**: 缩放自适应容差，确保任意缩放级别下体验一致
3. **旋转实现**: 保存原始 section 数据，避免累积旋转错误
4. **光标管理**: 集中式光标样式管理，根据状态自动切换
5. **吸附系统**: 多层级吸附 (网格→顶点→角度→对齐)，对齐辅助线
6. **360°摇杆**: Joystick 组件支持全方向画布移动

---

## 参考 seats.io 的关键特性

1. **视图原点**: 采用中心原点坐标系，便于定位
2. **悬浮控件**: Navigation HUD、Floor Picker 悬浮在画布上
3. **工具提示**: 状态栏显示当前工具的操作提示
4. **视觉反馈**: 悬停、选中、绘制预览等即时反馈
5. **快捷键**: 每个工具都有单字母快捷键
6. **无网格设计**: 与 seats.io 保持一致，不显示网格线 (可选开启)
