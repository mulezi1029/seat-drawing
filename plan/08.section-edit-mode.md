# 区域编辑模式（Section Edit Mode）需求文档

## 1. 背景与问题

### 1.1 现状
- 用户基于实际场馆底图绘制区域（Section）
- 底图可能分辨率较低或展示比例较小
- 直接在原图上绘制座位会非常困难（太小、难以精确定位）

### 1.2 核心问题：尺寸断层
| 层级 | 说明 | 问题 |
|------|------|------|
| 场馆底图 | 原始 SVG/图片，可能很小 | 不适合直接绘制精细的座位 |
| 区域轮廓 | 在底图上绘制的多边形 | 需要进入内部进行编辑 |
| 座位布局 | 需要精确排列的座位点 | 需要合适的缩放级别和坐标系 |

## 2. 需求概述

实现**区域编辑模式**：允许用户"进入"某个已绘制区域，在新的画布层中进行座位绘制，同时保持与原图的位置关联。

## 3. 功能需求

### 3.1 进入区域编辑

**触发方式**：
1. 双击某个区域
2. 右键区域 → 选择"编辑区域"
3. 选中区域后，点击工具栏"进入编辑"按钮
4. 快捷键：`Enter`（当选中单个区域时）

**进入前检查**：
- 必须只选中一个区域（多选时提示"请只选择一个区域进行编辑"）
- 该区域必须有有效多边形（points.length >= 3）

### 3.2 校准流程（Calibration）

进入编辑模式前，需要进行一次**校准**，建立区域局部坐标系与实际尺寸的映射关系。

**校准参数**：
```typescript
interface SectionCalibration {
  /** 区域实际宽度（米） */
  realWidth: number;
  /** 区域实际高度（米） */
  realHeight: number;
  /** 区域在世界坐标系中的边界框 */
  worldBounds: BoundingBox;
  /** 校准后的局部坐标系原点（相对于世界坐标） */
  localOrigin: Point;
  /** 像素/米 比例尺 */
  pixelsPerMeter: number;
}
```

**校准界面**：
1. 弹出校准对话框
2. 显示区域的实际像素尺寸（从 worldBounds 计算）
3. 用户输入实际宽高（米）
4. 系统自动计算 `pixelsPerMeter`
5. 可选：提供"使用默认值"（根据像素尺寸估算）

### 3.3 区域编辑画布层

**画布特性**：

| 特性 | 说明 |
|------|------|
| 坐标系 | 独立的局部坐标系（Local Coordinate System） |
| 原点 | 区域边界框的左上角为 (0, 0) |
| 尺寸 | 根据校准参数计算的虚拟尺寸 |
| 背景 | 原图裁剪/遮罩后的局部视图 |

**背景处理**：
```typescript
interface SectionEditBackground {
  /** 原始底图 URL */
  originalSvgUrl: string;
  /** 区域多边形在世界坐标系中的点 */
  sectionPoints: Point[];
  /** 区域边界框（用于裁剪） */
  bounds: BoundingBox;
  /** 背景变换：将原图对应区域映射到编辑画布 */
  backgroundTransform: {
    scale: number;
    translateX: number;
    translateY: number;
  };
}
```

**视觉呈现**：
- 背景显示原图被裁剪到区域多边形内的部分
- 使用 SVG `clipPath` 或 `mask` 实现多边形裁剪
- 区域外部半透明遮罩（可选），突出编辑区域

### 3.4 座位绘制功能

**座位类型**：
1. **单点座位** - 点击放置单个座位
2. **矩阵排列** - 批量生成行列座位
3. **弧线排列** - 沿着曲线排列座位（体育场常用）

**座位数据结构**：
```typescript
interface Seat {
  id: string;
  /** 局部坐标系中的位置 */
  localX: number;
  localY: number;
  /** 世界坐标系中的位置（计算得出） */
  worldX: number;
  worldY: number;
  row: string;      // 行号，如 "A"
  number: number;   // 座位号
  /** 座位角度（相对于正北，顺时针） */
  angle: number;
  /** 座位类型 */
  type: 'normal' | 'vip' | 'accessible' | 'empty';
}
```

**编辑工具**：
- 单点放置工具
- 矩阵绘制工具（拖拽确定行列范围）
- 座位选择/移动工具
- 座位删除工具

### 3.5 退出与保存

**退出方式**：
1. 点击"返回"按钮
2. 快捷键：`Esc`

**保存逻辑**：
- 座位坐标从局部坐标系转换回世界坐标系
- 更新父区域的 `seats` 数组
- 返回主画布，保持之前的视图状态

## 4. 状态管理

### 4.1 新增状态

```typescript
interface SectionEditState {
  /** 是否处于区域编辑模式 */
  isActive: boolean;
  /** 正在编辑的区域 ID */
  sectionId: string | null;
  /** 校准参数 */
  calibration: SectionCalibration | null;
  /** 编辑画布状态 */
  editCanvas: {
    scale: number;
    offsetX: number;
    offsetY: number;
  };
  /** 当前编辑工具 */
  activeTool: 'seat-point' | 'seat-matrix' | 'seat-arc' | 'select';
  /** 编辑中的座位 */
  seats: Seat[];
  /** 是否有未保存的更改 */
  hasUnsavedChanges: boolean;
};
```

### 4.2 状态流转

```
主画布 → 选中区域 → 触发编辑 → 校准对话框 → 区域编辑画布 → 保存/取消 → 返回主画布
```

## 5. UI 设计

### 5.1 校准对话框

```
+------------------------------------------+
|  区域校准                                  |
+------------------------------------------+
|                                          |
|  区域名称: 区域 A                          |
|  像素尺寸: 320px × 180px                   |
|                                          |
|  实际宽度: [________] 米                   |
|  实际高度: [________] 米                   |
|                                          |
|  计算比例: 1米 = 32像素                    |
|                                          |
|  [使用默认]        [取消]  [确认进入]       |
+------------------------------------------+
```

### 5.2 区域编辑界面

```
+--------------------------------------------------+
|  ← 返回      区域 A - 座位编辑          [保存]    |
+--------------------------------------------------+
|                                                  |
|  +--------------------------------------------+  |
|  |                                            |  |
|  |      [原图裁剪背景]                         |  |
|  |                                            |  |
|  |         +  +  +  +                         |  |
|  |         +  +  +  +    ← 座位矩阵            |  |
|  |         +  +  +  +                         |  |
|  |                                            |  |
|  +--------------------------------------------+  |
|            ↑ 编辑画布区域                        |
|                                                  |
|  左下角工具栏: 单点 | 矩阵 | 弧线 | 选择          |
|  右下角: 缩放控制 + 状态信息                      |
+--------------------------------------------------+
```

### 5.3 主画布交互增强

- 区域 hover 时显示"双击编辑"提示
- 选中区域时，工具栏显示"进入编辑"按钮

## 6. 坐标转换

### 6.1 世界坐标 ↔ 局部坐标

```typescript
// 世界坐标转局部坐标
function worldToLocal(worldPoint: Point, bounds: BoundingBox): Point {
  return {
    x: worldPoint.x - bounds.minX,
    y: worldPoint.y - bounds.minY,
  };
}

// 局部坐标转世界坐标
function localToWorld(localPoint: Point, bounds: BoundingBox): Point {
  return {
    x: localPoint.x + bounds.minX,
    y: localPoint.y + bounds.minY,
  };
}
```

### 6.2 实际尺寸 ↔ 像素

```typescript
// 米转像素
function metersToPixels(meters: number, pixelsPerMeter: number): number {
  return meters * pixelsPerMeter;
}

// 像素转米
function pixelsToMeters(pixels: number, pixelsPerMeter: number): number {
  return pixels / pixelsPerMeter;
}
```

## 7. 实现步骤

### Phase 1: 基础框架
1. 创建 `SectionEditState` 类型和状态管理
2. 实现校准对话框组件
3. 创建区域编辑画布容器

### Phase 2: 画布层
1. 实现背景裁剪/遮罩（原图局部显示）
2. 实现局部坐标系
3. 实现从主画布进入/退出编辑模式

### Phase 3: 座位绘制
1. 单点座位放置工具
2. 矩阵座位生成工具
3. 座位选择与编辑

### Phase 4: 数据流
1. 座位坐标转换（局部 ↔ 世界）
2. 保存/取消逻辑
3. 与主画布数据同步

## 8. 注意事项

1. **性能优化**：区域编辑时的背景裁剪应该使用 SVG `clipPath`，避免大图的完整渲染
2. **边界处理**：确保生成的座位不会超出区域多边形边界
3. **撤销重做**：编辑模式内支持撤销重做，退出时统一保存
4. **异常处理**：校准参数不合理时（如宽高为0）给出警告
5. **多区域关联**：考虑是否支持跨区域座位（如过道两侧），首期可限定座位只能属于一个区域

## 9. 相关文件

- `app/src/types/index.ts` - 类型定义扩展
- `app/src/components/section-edit/` - 区域编辑相关组件
  - `SectionEditModal.tsx` - 区域编辑模态框容器
  - `CalibrationDialog.tsx` - 校准对话框
  - `SectionEditCanvas.tsx` - 编辑画布
  - `SeatTools.tsx` - 座位工具栏
- `app/src/hooks/useSectionEdit.ts` - 区域编辑状态管理 Hook

---

*文档创建日期: 2026-02-26*
*关联需求: 座位绘制、区域管理*
