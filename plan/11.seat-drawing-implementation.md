# 座位绘制功能实现文档

## 概述

本文档描述座位绘制功能的完整实现，该功能允许用户在完成区域校准后，在区域内绘制和编辑座位。

## 功能特性

### 1. 编辑模式界面

完成校准后，用户进入编辑模式，界面包含：

- **顶部工具栏**：显示区域名称、座位数量、保存按钮、返回按钮
- **左侧工具面板**：座位绘制工具选择
- **中央画布**：显示区域背景和座位，支持交互操作
- **右侧属性面板**：编辑选中座位的属性

### 2. 座位绘制工具

#### 2.1 选择工具 (V)
- 单击选择单个座位
- Ctrl+单击多选座位
- 框选多个座位
- 拖拽移动选中的座位

#### 2.2 单排座位工具 (1)
- **拖拽绘制**：按住鼠标拖拽定义座位排列方向和长度
- **实时预览**：
  - 显示蓝色半透明圆圈预览座位位置
  - 显示虚线连接起点和终点
  - 中间显示黑色方块标签，显示座位数量
- **自动计算**：根据拖拽距离自动计算座位数量
- **自动旋转**：座位角度自动对齐拖拽方向
- **参照 seats.io**：完全模仿 seats.io 的交互体验

#### 2.3 矩阵座位工具 (2)
- 拖拽绘制矩形区域
- 根据区域大小自动计算行列数
- 实时预览矩阵范围和座位数量
- 使用校准的座位尺寸和间距

### 3. 座位编辑功能

#### 3.1 座位选择
- **单选**：单击座位
- **多选**：Ctrl+单击座位
- **框选**：拖拽矩形框选择多个座位
- **视觉反馈**：选中座位显示蓝色边框

#### 3.2 座位移动
- 拖拽选中的座位进行移动
- 支持批量移动多个座位
- 实时预览移动效果（半透明显示）

#### 3.3 座位删除
- Delete 或 Backspace 键删除选中座位
- 支持批量删除

#### 3.4 座位属性编辑
- **行号**：字母标识（A, B, C...）
- **座位号**：数字标识（1, 2, 3...）
- **座位类型**：正常/VIP/无障碍/空位
- **座位角度**：0-360°旋转角度

### 4. 画布交互

#### 4.1 缩放控制
- Ctrl+滚轮：以鼠标位置为中心缩放
- 缩放范围：50%-1000%
- 保持鼠标位置不变的智能缩放

#### 4.2 平移控制
- Space+拖拽：平移画布
- 支持键盘快捷键（方向键）

#### 4.3 快捷键
- **V**：切换到选择工具
- **1**：切换到单排座位工具
- **2**：切换到矩阵座位工具
- **Space**：临时切换到平移模式
- **Delete/Backspace**：删除选中座位

## 技术架构

### 核心组件

#### EditMode.tsx
编辑模式主容器，负责：
- 座位状态管理（添加、更新、删除、选择）
- 工具切换管理
- 保存和退出逻辑
- 布局协调（工具面板、画布、属性面板）

#### EditModeCanvas.tsx
编辑画布组件，负责：
- SVG 渲染（背景图、区域、座位）
- 鼠标交互处理（点击、拖拽、框选）
- 坐标转换（屏幕坐标 ↔ 世界坐标）
- 绘制预览（矩阵范围、框选框）
- 画布缩放和平移

#### SeatToolsPanel.tsx
座位工具面板，提供：
- 工具按钮（选择、单排、矩阵）
- 工具激活状态显示
- 快捷键提示

#### SeatPropertiesPanel.tsx
座位属性面板，支持：
- 单个座位属性编辑（行号、座位号）
- 批量属性编辑（类型、角度）
- 座位信息显示（位置、ID）

### 数据结构

#### Seat 接口
```typescript
interface Seat {
  id: string;           // 唯一标识符
  x: number;            // 世界坐标 X
  y: number;            // 世界坐标 Y
  row: string;          // 行号（如 "A"）
  number: number;       // 座位号
  type: SeatType;       // 座位类型
  angle: number;        // 座位角度（0-360°）
}
```

#### SeatType 枚举
```typescript
type SeatType = 'normal' | 'vip' | 'accessible' | 'empty';
```

#### SectionEditTool 枚举
```typescript
type SectionEditTool = 'select' | 'single-row' | 'matrix' | 'arc-row';
```

### 坐标系统

#### 世界坐标系
- 座位存储在世界坐标系中
- 与主画布共享同一坐标系
- 便于在主画布上渲染座位

#### 坐标转换
- `screenToWorld()`：屏幕坐标 → 世界坐标
- `worldToLocal()`：世界坐标 → 局部坐标（区域内）
- `localToWorld()`：局部坐标 → 世界坐标

### 状态管理

#### useSectionEdit Hook
管理区域编辑的全局状态：
- 编辑模式激活状态
- 当前编辑的区域 ID
- 校准/编辑阶段切换
- 校准数据管理
- 座位数据保存

#### EditMode 本地状态
- 当前工具选择
- 座位列表
- 选中座位 ID 集合
- 绘制状态（拖拽、框选）

## 交互流程

### 1. 进入编辑模式
```
主画布 → 双击区域 → 校准向导 → 完成校准 → 编辑模式
```

### 2. 绘制座位流程

#### 单排座位（参照 seats.io）
```
1. 选择单排座位工具（按 1）
2. 在画布上按住鼠标拖拽
3. 实时预览：
   - 蓝色圆圈显示座位位置
   - 虚线连接起点和终点
   - 黑色方块显示座位数量
4. 释放鼠标完成绘制
5. 座位自动对齐拖拽方向
```

#### 矩阵座位
```
1. 选择矩阵座位工具（按 2）
2. 按住鼠标拖拽
3. 实时预览矩阵范围和座位数
4. 释放鼠标完成绘制
```

### 3. 编辑座位流程

#### 移动座位
```
1. 选择工具（按 V）
2. 单击或框选座位
3. 拖拽移动
4. 释放鼠标完成移动
```

#### 编辑属性
```
1. 选择座位
2. 在右侧属性面板修改
   - 行号
   - 座位号
   - 类型
   - 角度
3. 自动保存到状态
```

#### 删除座位
```
1. 选择座位
2. 按 Delete 或 Backspace
3. 座位被删除
```

### 4. 保存退出
```
1. 点击"保存"按钮
2. 座位数据保存到区域
3. 自动返回主画布
```

## 视觉设计

### 座位渲染
- **形状**：正方形（使用校准的 size）
- **颜色**：
  - 正常座位：白色填充
  - VIP 座位：金色填充 (#fbbf24)
- **边框**：
  - 未选中：区域颜色，2px
  - 选中：蓝色 (#3b82f6)，3px
- **标签**：座位号居中显示

### 背景显示
- **完整底图**：半透明显示（opacity: 0.7）
- **区域内高亮**：使用 clipPath 裁剪，更高透明度（opacity: 0.8）
- **区域外遮罩**：黑色半透明（opacity: 0.3）
- **区域边框**：虚线边框，使用区域颜色

### 交互反馈
- **拖拽座位**：半透明显示（opacity: 0.6）
- **框选框**：蓝色半透明填充，虚线边框
- **单排预览**（seats.io 风格）：
  - 蓝色半透明圆圈（rgba(59, 130, 246, 0.3)）
  - 蓝色虚线连接线
  - 黑色方块标签（#1e293b），显示座位数量
- **矩阵预览**：虚线矩形框，显示行列数和总座位数
- **鼠标样式**：
  - 选择工具：grab/grabbing
  - 单排/矩阵工具：crosshair
  - 平移模式：grab

## 核心算法

### 单排座位计算（seats.io 风格）
```typescript
// 计算拖拽距离
const distance = Math.hypot(dx, dy);

// 根据距离计算座位数量
const cellWidth = seatVisual.size + seatVisual.gapX;
const seatCount = Math.max(1, Math.round(distance / cellWidth));

// 计算拖拽角度
const angle = Math.atan2(dy, dx);

// 沿着拖拽方向均匀分布座位
for (let i = 0; i < seatCount; i++) {
  const t = seatCount === 1 ? 0 : i / (seatCount - 1);
  seats.push({
    x: drawStart.x + dx * t,
    y: drawStart.y + dy * t,
    angle: angle * 180 / Math.PI,  // 自动旋转对齐
  });
}
```

### 矩阵座位计算
```typescript
const cellWidth = seatVisual.size + seatVisual.gapX;
const cellHeight = seatVisual.size + seatVisual.gapY;
const cols = Math.max(1, Math.floor(width / cellWidth));
const rows = Math.max(1, Math.floor(height / cellHeight));
```

### 框选座位检测
```typescript
const selectedIds = seats
  .filter((s) => s.x >= minX && s.x <= maxX && s.y >= minY && s.y <= maxY)
  .map((s) => s.id);
```

### 座位拖拽偏移
```typescript
const dx = dragCurrentWorld.x - dragStartWorld.x;
const dy = dragCurrentWorld.y - dragStartWorld.y;
displayX = seat.x + dx;
displayY = seat.y + dy;
```

## 文件结构

```
app/src/
├── types/
│   └── index.ts                    # 扩展 Seat、SeatType、SectionEditTool 类型
├── utils/
│   └── coordinate.ts               # 添加 worldToLocal、localToWorld 函数
├── hooks/
│   └── useSectionEdit.ts           # 添加 saveSeats 方法
├── components/
│   └── section-edit/
│       ├── EditMode.tsx            # 编辑模式主容器（新建）
│       ├── EditModeCanvas.tsx      # 编辑画布组件（新建）
│       ├── SeatToolsPanel.tsx      # 座位工具面板（新建）
│       ├── SeatPropertiesPanel.tsx # 座位属性面板（新建）
│       ├── SectionEditModal.tsx    # 更新：集成 EditMode
│       └── index.ts                # 更新：导出新组件
└── App.tsx                         # 更新：添加 handleSaveSeats
```

## 使用示例

### 绘制单排座位（seats.io 风格）
1. 完成区域校准
2. 按 `1` 切换到单排座位工具
3. 在画布上按住鼠标拖拽
4. 实时预览：
   - 看到蓝色圆圈预览座位
   - 看到虚线连接线
   - 看到黑色方块显示数量
5. 释放鼠标完成绘制
6. 座位自动对齐拖拽方向

### 绘制矩阵座位
1. 完成区域校准
2. 按 `2` 切换到矩阵座位工具
3. 在画布上拖拽矩形
4. 实时预览座位矩阵
5. 释放鼠标完成绘制

### 编辑座位属性
1. 按 `V` 切换到选择工具
2. 单击选择座位
3. 在右侧面板修改属性：
   - 修改行号为 "B"
   - 修改座位号为 10
   - 修改类型为 "VIP"
   - 修改角度为 45°

### 批量操作
1. 框选多个座位
2. 在右侧面板批量修改类型或角度
3. 或拖拽批量移动
4. 或按 Delete 批量删除

## 与校准功能的集成

### 数据流
```
校准完成 → 保存校准数据 → 进入编辑模式 → 绘制座位 → 保存座位数据 → 返回主画布
```

### 校准数据使用
- **座位尺寸**：使用 `calibration.seatVisual.size`
- **座位间距**：使用 `calibration.seatVisual.gapX` 和 `gapY`
- **画布缩放**：继承 `calibration.canvasScale`

### 数据持久化
- 座位数据保存到 `Section.seats` 数组
- 座位坐标使用世界坐标系
- 可在主画布上直接渲染

## 后续优化方向

1. **弧线排列工具**：沿曲线排列座位（体育场常用）
2. **自动编号**：移动座位后自动重排行号和座位号
3. **撤销/重做**：支持编辑历史管理
4. **座位模板**：预设常用座位排列模式
5. **批量编辑增强**：支持更多批量操作（如批量修改行号）

## 技术亮点

1. **seats.io 风格交互**：完全模仿 seats.io 的拖拽绘制体验
2. **实时预览**：
   - 单排座位：蓝色圆圈 + 虚线 + 数量标签
   - 矩阵座位：虚线框 + 行列数标签
3. **智能计算**：
   - 根据拖拽距离自动计算座位数量
   - 座位自动对齐拖拽方向
4. **坐标系统**：统一的世界坐标系，便于数据管理和渲染
5. **智能缩放**：以鼠标位置为中心的缩放，保持视觉连续性
6. **键盘快捷键**：提高操作效率
7. **组件化设计**：清晰的职责分离，易于维护和扩展

---

*文档创建日期: 2026-02-26*
*关联文档: plan/10.calibration-wizard-seats-io-style.md*
