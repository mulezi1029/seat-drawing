# ESLint 错误修复计划

## Context

运行 ESLint 后发现了 7 个错误，需要修复以确保代码质量和构建通过。

**发现的错误：**
1. 5 个未使用变量错误 (`@typescript-eslint/no-unused-vars`)
2. 1 个级联渲染风险错误 (`react-hooks/set-state-in-effect`)
3. 1 个 Fast Refresh 问题 (`react-refresh/only-export-components`)

---

## 错误详情与修复方案

### 1. 未使用的变量

#### App.tsx (2个错误)
```typescript
// Line 64-65
const [_isShiftPressed, _setIsShiftPressed] = useState(false);
const [_isCtrlPressed, _setIsCtrlPressed] = useState(false);
```
**修复方案：** 使用 `// eslint-disable-next-line` 注释保留这些变量（它们以下划线开头，是有意保留的）

#### Canvas.tsx (3个错误)
```typescript
// Line 20
import { ..., rotatePolygon } from '@/utils/coordinate';  // 未使用

// Line 143-144
const [_mousePosition, setMousePosition] = useState<Point | null>(null);  // _mousePosition 未使用
const [_snapResult, setSnapResult] = useState<SnapResult | null>(null);   // _snapResult 未使用
```
**修复方案：**
- `rotatePolygon`: 删除未使用的导入
- `_mousePosition`, `_snapResult`: 使用 `// eslint-disable-next-line` 注释（有意保留供调试）

---

### 2. 级联渲染风险 (严重)

#### Canvas.tsx:199
```typescript
useEffect(() => {
  if (isPanningRef.current) {
    setCursorStyle('grabbing');  // ❌ 在 effect 中直接调用 setState
  } else if (isDraggingElementRef.current) {
    setCursorStyle('grabbing');
  } else if (isRotatingRef.current) {
    setCursorStyle('grabbing');
  } else if (isSpacePressed || isHandToolActive) {
    setCursorStyle('grab');
  } else if (activeTool === 'section' || activeTool === 'polygon') {
    setCursorStyle('crosshair');
  } else {
    setCursorStyle('default');
  }
}, [isSpacePressed, isHandToolActive, activeTool, isPanning, isDraggingElement, isRotating]);
```

**修复方案：**
将光标样式的逻辑从 useEffect 中移出，改为在事件处理函数中直接设置，或使用 useLayoutEffect + ref 来避免级联渲染。

**推荐方案：** 使用同步 ref 设置样式，避免状态更新：
```typescript
// 不使用 useState 管理 cursorStyle，而是直接在 ref 上操作
const cursorStyleRef = useRef('default');
const setCursorStyle = useCallback((style: string) => {
  cursorStyleRef.current = style;
  if (containerRef.current) {
    containerRef.current.style.cursor = style;
  }
}, []);
```

---

### 3. Fast Refresh 问题

#### button.tsx:128
```typescript
export { Button, buttonVariants };  // 导出了非组件内容 buttonVariants
```

**修复方案：**
将 `buttonVariants` 移动到单独的工具文件中，或者使用 `// eslint-disable-next-line` 注释（如果这是 shadcn/ui 生成的代码，通常保留原样）

---

## 文件修改列表

| 文件 | 修改内容 |
|------|----------|
| `app/src/App.tsx` | 为 `_isShiftPressed` 和 `_isCtrlPressed` 添加 eslint-disable 注释 |
| `app/src/components/canvas/Canvas.tsx` | 1. 删除未使用的 `rotatePolygon` 导入<br>2. 为 `_mousePosition` 和 `_snapResult` 添加 eslint-disable 注释<br>3. 重构光标样式逻辑，避免在 useEffect 中调用 setState |
| `app/src/components/ui/button.tsx` | 为 `buttonVariants` 导出添加 eslint-disable 注释（或移动到单独文件） |

---

## 验证清单

- [ ] 运行 `pnpm lint` 无错误
- [ ] 运行 `pnpm build` 构建成功
- [ ] 画布光标样式正常工作（拖拽时显示 grabbing，平时显示 grab/crosshair/default）
- [ ] 复制功能仍然可用（Ctrl+C/Ctrl+D）
