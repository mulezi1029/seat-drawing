# Venue Seat Designer - 功能清单与技术方案

## 🌐 在线访问
**地址**: https://axjg7ovmjzxbs.ok.kimi.link

---

## 📋 完整功能清单

### 1. 文件管理

| 功能 | 描述 |
|------|------|
| SVG 上传 | 支持上传任意 SVG 格式的场馆平面图作为底图 |
| 数据导出 | 将场馆配置导出为 JSON 格式，包含所有区域和座位信息 |
| 数据导入 | 导入之前导出的 JSON 配置，恢复工作状态 |

### 2. Section 区域管理

| 功能 | 描述 |
|------|------|
| 多边形绘制 | 点击画布逐点绘制区域边界，双击或 Enter 完成 |
| 区域命名 | 完成绘制时输入区域名称 |
| 进入/退出区域 | 点击区域卡片上的 Enter 进入编辑座位模式 |
| 区域属性编辑 | 修改区域名称、颜色、透明度 |
| 区域删除 | 删除整个区域及其包含的所有座位 |

### 3. 座位绘制工具（Section 内）

| 工具 | 快捷键 | 功能描述 |
|------|--------|----------|
| **Select** | V | 单击选座位、框选多座位、拖拽移动座位 |
| **Single** | S | 单击放置单个座位 |
| **Row** | R | 拖拽生成一排等间距座位 |
| **Line** | L | 点击多个点形成路径，沿路径生成座位 |

### 4. 座位编辑功能

| 功能 | 描述 |
|------|------|
| 属性编辑 | 修改座位的行号、座位号、颜色 |
| 批量编辑 | 同时修改多个选中座位的属性 |
| 对齐分布 | 8 种对齐方式：左/中/右/上/中/下/水平分布/垂直分布 |
| 微移调整 | 方向键精确移动座位（1px），Shift+方向键（10px）|
| 删除 | 单个或批量删除选中座位 |
| 拖拽移动 | 选中座位后拖拽到新位置 |

### 5. 画布导航

| 功能 | 操作方式 |
|------|----------|
| 平移 | 手型工具按钮 / 按住 Space + 拖拽 / 中键拖拽 |
| 缩放 | 滑块控件 / +/- 按钮 / 鼠标滚轮 |
| 适应视图 | 一键居中并缩放内容到可视区域 |
| 重置视图 | 恢复默认缩放和位置 |

### 6. 视图设置

| 功能 | 描述 |
|------|------|
| 网格显示 | 开关网格显示 |
| 网格大小 | 5-50px 可调 |
| 网格吸附 | 绘制/移动时自动吸附到网格 |
| 背景色 | 多种画布背景色可选 |

### 7. 撤销重做

| 功能 | 快捷键 |
|------|--------|
| 撤销 | Ctrl+Z |
| 重做 | Ctrl+Y / Ctrl+Shift+Z |
| 历史记录 | 最多保存 50 步操作历史 |

---

## 🛠 技术方案

### 技术栈

| 层级 | 技术 | 用途 |
|------|------|------|
| **框架** | React 18 + TypeScript | UI 组件开发，类型安全 |
| **构建工具** | Vite 7 | 快速开发服务器和构建 |
| **样式** | Tailwind CSS 3.4 | 原子化 CSS 样式 |
| **UI 组件** | shadcn/ui | 基础 UI 组件库 |
| **状态管理** | React Hooks | 本地状态管理 |
| **SVG 操作** | 原生 SVG API | 画布渲染和交互 |

### 项目结构

```
src/
├── hooks/
│   ├── useVenueDesigner.ts    # 核心业务逻辑（场馆数据、座位操作）
│   └── useUndoRedo.ts         # 撤销重做功能钩子
├── components/
│   ├── canvas/
│   │   └── SVGCanvas.tsx      # SVG 画布组件（渲染、交互）
│   ├── Toolbar.tsx            # 顶部工具栏
│   ├── SectionPanel.tsx       # 左侧区域列表面板
│   ├── SeatPanel.tsx          # 右侧座位编辑面板
│   ├── ConfigDialog.tsx       # 设置对话框
│   ├── SectionNameDialog.tsx  # 区域命名对话框
│   └── DataDialog.tsx         # 数据导入导出对话框
├── types/
│   └── index.ts               # TypeScript 类型定义
└── App.tsx                    # 主应用组件
```

### 核心数据结构

```typescript
// 场馆数据
interface VenueMap {
  id: string;
  name: string;
  svgUrl: string | null;      // SVG 底图 URL
  svgContent: string | null;  // SVG 原始内容
  sections: Section[];        // 区域列表
  width: number;              // 画布宽度
  height: number;             // 画布高度
}

// 区域（Section）
interface Section {
  id: string;
  name: string;
  points: Point[];      // 多边形顶点坐标
  color: string;        // 区域颜色
  seats: Seat[];        // 座位列表
  opacity: number;      // 透明度
}

// 座位
interface Seat {
  id: string;
  x: number;            // X 坐标
  y: number;            // Y 坐标
  row: string;          // 行号（如 "A"）
  number: number;       // 座位号
  status: 'available' | 'occupied' | 'reserved' | 'disabled';
  color?: string;       // 座位颜色
  sectionId: string;    // 所属区域 ID
}

// 编辑器状态
interface EditorState {
  mode: 'view' | 'draw-section' | 'draw-seat';
  selectedSectionId: string | null;
  selectedSeatIds: string[];
  seatTool: 'select' | 'single' | 'row' | 'line';
  canvasTool: 'auto' | 'pan';
  zoom: number;
  pan: { x: number; y: number };
}
```

---

## ⭐ 技术亮点

### 1. 撤销重做系统（useUndoRedo）

使用命令模式实现历史记录管理：

```typescript
interface UndoRedoState<T> {
  past: T[];      // 历史状态
  present: T;     // 当前状态
  future: T[];    // 重做状态
}
```

- 每次状态变化自动保存快照
- 最多保留 50 步历史
- 新操作自动清空未来状态

### 2. 配置值实时同步（Refs 模式）

解决 useCallback 闭包问题，使用 refs 存储最新配置值：

```typescript
const drawConfigRef = useRef(drawConfig);
const viewConfigRef = useRef(viewConfig);

useEffect(() => {
  drawConfigRef.current = drawConfig;
}, [drawConfig]);

// 在回调中使用 ref 获取最新值
const addSeatsInRow = useCallback((...) => {
  const currentSpacing = drawConfigRef.current.seatSpacing;
  // ...
}, []);
```

### 3. 射线投射算法（边界检测）

检测点是否在多边形内，用于限制座位只能绘制在所属区域内：

```typescript
function isPointInPolygon(point: Point, polygon: Point[]): boolean {
  let inside = false;
  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i].x, yi = polygon[i].y;
    const xj = polygon[j].x, yj = polygon[j].y;
    
    const intersect = ((yi > point.y) !== (yj > point.y)) &&
      (point.x < (xj - xi) * (point.y - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}
```

### 4. 座位对齐算法

支持 8 种对齐方式：
- 水平对齐：左对齐、水平居中、右对齐、水平等分布
- 垂直对齐：顶对齐、垂直居中、底对齐、垂直等分布

### 5. 多模式交互系统

- **Canvas Tool**: 自动模式 / 平移模式
- **Seat Tool**: 4 种座位绘制/编辑工具
- **快捷键系统**: 工具切换、撤销重做、微移调整

---

## 🐛 本次修复的问题

### 1. 拖动调整座位位置失效
**原因**: 拖动时每次移动都更新 `seatDragStart`，导致 delta 计算错误
**解决**: 改为增量移动模式，每次移动后更新起始位置

### 2. 座位间距调整不生效
**原因**: `useCallback` 闭包捕获了旧的 `drawConfig` 值
**解决**: 使用 refs 模式存储最新配置值，回调中通过 ref 读取

### 3. 拖动画布速度太慢
**原因**: pan 计算时除以 zoom，导致移动距离变小
**解决**: 调整 pan 公式，乘以系数 1.5 提升移动速度

---

## 🚀 后续可扩展功能

1. **座位分组** - 支持创建座位组，批量操作
2. **价格区域** - 不同区域设置不同票价
3. **预览模式** - 模拟购票选座流程
4. **导出图片** - 导出为 PNG/SVG 格式
5. **多人协作** - 实时同步编辑（WebSocket）
6. **模板库** - 预设常见场馆模板
7. **3D 预览** - 3D 视角查看座位布局
8. **座位状态管理** - 已售、预留、禁用等状态
